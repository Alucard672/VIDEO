{% extends "base.html" %}

{% block title %}任务管理 - 视频搬运矩阵自动化系统{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-tasks"></i>
        任务管理
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                <i class="fas fa-plus"></i> 创建任务
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="refreshTasks()">
                <i class="fas fa-sync-alt"></i> 刷新
            </button>
            <button type="button" class="btn btn-outline-info" onclick="showTaskStatistics()">
                <i class="fas fa-chart-bar"></i> 统计
            </button>
        </div>
    </div>
</div>

<!-- 任务统计卡片 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="total-tasks">0</h4>
                        <p class="card-text">总任务数</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-list fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="running-tasks">0</h4>
                        <p class="card-text">运行中</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-play-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="completed-tasks">0</h4>
                        <p class="card-text">已完成</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-danger">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title" id="failed-tasks">0</h4>
                        <p class="card-text">失败</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-times-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 任务筛选和搜索 -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="taskTypeFilter" class="form-label">任务类型</label>
                        <select class="form-select" id="taskTypeFilter" onchange="filterTasks()">
                            <option value="">全部类型</option>
                            {% for task_type in task_types %}
                            <option value="{{ task_type.value }}">{{ task_type.label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="statusFilter" class="form-label">任务状态</label>
                        <select class="form-select" id="statusFilter" onchange="filterTasks()">
                            <option value="">全部状态</option>
                            <option value="pending">等待中</option>
                            <option value="running">运行中</option>
                            <option value="completed">已完成</option>
                            <option value="failed">失败</option>
                            <option value="cancelled">已取消</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="priorityFilter" class="form-label">优先级</label>
                        <select class="form-select" id="priorityFilter" onchange="filterTasks()">
                            <option value="">全部优先级</option>
                            <option value="1">低</option>
                            <option value="2">普通</option>
                            <option value="3">高</option>
                            <option value="4">紧急</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="taskSearch" class="form-label">搜索任务</label>
                        <input type="text" class="form-control" id="taskSearch" placeholder="输入任务名称..." onkeyup="searchTasks()">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 任务列表 -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list"></i>
                    任务列表
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="tasksTable">
                        <thead>
                            <tr>
                                <th>任务名称</th>
                                <th>类型</th>
                                <th>状态</th>
                                <th>优先级</th>
                                <th>进度</th>
                                <th>创建时间</th>
                                <th>执行时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody">
                            {% for task in tasks %}
                            <tr data-task-id="{{ task.id }}">
                                <td>
                                    <strong>{{ task.name }}</strong>
                                    {% if task.error_message %}
                                    <br><small class="text-danger">{{ task.error_message }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ task.task_type }}</span>
                                </td>
                                <td>
                                    <span class="status-badge status-{{ task.status }}">
                                        {{ task.status_text }}
                                    </span>
                                </td>
                                <td>
                                    {% if task.priority == 4 %}
                                    <span class="badge bg-danger">紧急</span>
                                    {% elif task.priority == 3 %}
                                    <span class="badge bg-warning">高</span>
                                    {% elif task.priority == 2 %}
                                    <span class="badge bg-info">普通</span>
                                    {% else %}
                                    <span class="badge bg-secondary">低</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar task-progress" 
                                             style="width: {{ task.progress }}%"
                                             data-task-id="{{ task.id }}">
                                            {{ task.progress }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <small>{{ task.created_time }}</small>
                                </td>
                                <td>
                                    {% if task.started_time %}
                                    <small>{{ task.started_time }}</small>
                                    {% else %}
                                    <small class="text-muted">未开始</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-info" 
                                                onclick="viewTaskDetails('{{ task.id }}')"
                                                data-bs-toggle="tooltip" title="查看详情">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        
                                        {% if task.status in ['pending', 'running'] %}
                                        <button type="button" class="btn btn-outline-warning" 
                                                onclick="pauseTask('{{ task.id }}')"
                                                data-bs-toggle="tooltip" title="暂停任务">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" 
                                                onclick="cancelTask('{{ task.id }}')"
                                                data-bs-toggle="tooltip" title="取消任务">
                                            <i class="fas fa-stop"></i>
                                        </button>
                                        {% endif %}
                                        
                                        {% if task.status == 'failed' %}
                                        <button type="button" class="btn btn-outline-success" 
                                                onclick="retryTask('{{ task.id }}')"
                                                data-bs-toggle="tooltip" title="重试任务">
                                            <i class="fas fa-redo"></i>
                                        </button>
                                        {% endif %}
                                        
                                        {% if task.status in ['completed', 'failed', 'cancelled'] %}
                                        <button type="button" class="btn btn-outline-danger" 
                                                onclick="deleteTask('{{ task.id }}')"
                                                data-bs-toggle="tooltip" title="删除任务">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页 -->
                <nav aria-label="任务分页">
                    <ul class="pagination justify-content-center" id="tasksPagination">
                        <!-- 分页按钮将通过JavaScript动态生成 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- 创建任务模态框 -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">创建新任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createTaskForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="taskName" class="form-label">任务名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="taskName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="taskType" class="form-label">任务类型 <span class="text-danger">*</span></label>
                                <select class="form-select" id="taskType" required onchange="updateTaskParams()">
                                    <option value="">请选择任务类型</option>
                                    {% for task_type in task_types %}
                                    <option value="{{ task_type.value }}">{{ task_type.label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="taskPriority" class="form-label">优先级</label>
                                <select class="form-select" id="taskPriority">
                                    <option value="1">低</option>
                                    <option value="2" selected>普通</option>
                                    <option value="3">高</option>
                                    <option value="4">紧急</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scheduledTime" class="form-label">计划执行时间</label>
                                <input type="datetime-local" class="form-control" id="scheduledTime">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">任务描述</label>
                        <textarea class="form-control" id="taskDescription" rows="3" placeholder="请输入任务描述..."></textarea>
                    </div>
                    
                    <!-- 动态参数配置区域 -->
                    <div id="taskParamsContainer" style="display: none;">
                        <h6>任务参数配置</h6>
                        <div id="taskParamsContent">
                            <!-- 参数配置内容将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitCreateTask()">
                    <i class="fas fa-plus"></i> 创建任务
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 任务详情模态框 -->
<div class="modal fade" id="taskDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">任务详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="taskDetailsContent">
                    <!-- 任务详情内容将通过JavaScript动态加载 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 任务统计模态框 -->
<div class="modal fade" id="taskStatisticsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">任务统计分析</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="taskStatisticsContent">
                    <!-- 统计图表将通过JavaScript动态生成 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let pageSize = 20;
let totalTasks = 0;
let allTasks = [];
let filteredTasks = [];

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadTasks();
    loadTaskStatistics();
    
    // 定期刷新任务状态
    setInterval(refreshTaskStatus, 5000);
});

// 加载任务列表
function loadTasks() {
    apiRequest('/api/tasks')
        .then(data => {
            allTasks = data.tasks || [];
            filteredTasks = [...allTasks];
            totalTasks = allTasks.length;
            
            updateTaskStatistics();
            renderTasks();
            renderPagination();
        })
        .catch(error => {
            showNotification('加载任务列表失败: ' + error.message, 'error');
        });
}

// 刷新任务状态
function refreshTaskStatus() {
    // 只刷新运行中的任务
    const runningTasks = allTasks.filter(task => task.status === 'running');
    
    runningTasks.forEach(task => {
        apiRequest(`/api/tasks/${task.id}`)
            .then(taskData => {
                // 更新任务数据
                const index = allTasks.findIndex(t => t.id === task.id);
                if (index !== -1) {
                    allTasks[index] = taskData;
                    
                    // 更新界面
                    updateTaskRow(taskData);
                }
            })
            .catch(error => {
                console.error(`刷新任务 ${task.id} 状态失败:`, error);
            });
    });
}

// 更新任务行
function updateTaskRow(task) {
    const row = document.querySelector(`tr[data-task-id="${task.id}"]`);
    if (!row) return;
    
    // 更新状态
    const statusBadge = row.querySelector('.status-badge');
    if (statusBadge) {
        statusBadge.className = `status-badge status-${task.status}`;
        statusBadge.textContent = task.status_text;
    }
    
    // 更新进度
    const progressBar = row.querySelector('.task-progress');
    if (progressBar) {
        progressBar.style.width = `${task.progress}%`;
        progressBar.textContent = `${task.progress}%`;
    }
}

// 更新任务统计
function updateTaskStatistics() {
    const stats = {
        total: allTasks.length,
        running: allTasks.filter(t => t.status === 'running').length,
        completed: allTasks.filter(t => t.status === 'completed').length,
        failed: allTasks.filter(t => t.status === 'failed').length
    };
    
    document.getElementById('total-tasks').textContent = stats.total;
    document.getElementById('running-tasks').textContent = stats.running;
    document.getElementById('completed-tasks').textContent = stats.completed;
    document.getElementById('failed-tasks').textContent = stats.failed;
}

// 渲染任务列表
function renderTasks() {
    const tbody = document.getElementById('tasksTableBody');
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    const tasksToShow = filteredTasks.slice(startIndex, endIndex);
    
    tbody.innerHTML = '';
    
    tasksToShow.forEach(task => {
        const row = createTaskRow(task);
        tbody.appendChild(row);
    });
    
    // 初始化工具提示
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
}

// 创建任务行
function createTaskRow(task) {
    const row = document.createElement('tr');
    row.setAttribute('data-task-id', task.id);
    
    const priorityBadges = {
        1: '<span class="badge bg-secondary">低</span>',
        2: '<span class="badge bg-info">普通</span>',
        3: '<span class="badge bg-warning">高</span>',
        4: '<span class="badge bg-danger">紧急</span>'
    };
    
    row.innerHTML = `
        <td>
            <strong>${task.name}</strong>
            ${task.error_message ? `<br><small class="text-danger">${task.error_message}</small>` : ''}
        </td>
        <td>
            <span class="badge bg-secondary">${task.task_type}</span>
        </td>
        <td>
            <span class="status-badge status-${task.status}">
                ${task.status_text}
            </span>
        </td>
        <td>
            ${priorityBadges[task.priority] || priorityBadges[2]}
        </td>
        <td>
            <div class="progress" style="height: 20px;">
                <div class="progress-bar task-progress" 
                     style="width: ${task.progress}%"
                     data-task-id="${task.id}">
                    ${task.progress}%
                </div>
            </div>
        </td>
        <td>
            <small>${formatTime(task.created_time)}</small>
        </td>
        <td>
            ${task.started_time ? `<small>${formatTime(task.started_time)}</small>` : '<small class="text-muted">未开始</small>'}
        </td>
        <td>
            ${createActionButtons(task)}
        </td>
    `;
    
    return row;
}

// 创建操作按钮
function createActionButtons(task) {
    let buttons = `
        <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-info" 
                    onclick="viewTaskDetails('${task.id}')"
                    data-bs-toggle="tooltip" title="查看详情">
                <i class="fas fa-eye"></i>
            </button>
    `;
    
    if (['pending', 'running'].includes(task.status)) {
        buttons += `
            <button type="button" class="btn btn-outline-warning" 
                    onclick="pauseTask('${task.id}')"
                    data-bs-toggle="tooltip" title="暂停任务">
                <i class="fas fa-pause"></i>
            </button>
            <button type="button" class="btn btn-outline-danger" 
                    onclick="cancelTask('${task.id}')"
                    data-bs-toggle="tooltip" title="取消任务">
                <i class="fas fa-stop"></i>
            </button>
        `;
    }
    
    if (task.status === 'failed') {
        buttons += `
            <button type="button" class="btn btn-outline-success" 
                    onclick="retryTask('${task.id}')"
                    data-bs-toggle="tooltip" title="重试任务">
                <i class="fas fa-redo"></i>
            </button>
        `;
    }
    
    if (['completed', 'failed', 'cancelled'].includes(task.status)) {
        buttons += `
            <button type="button" class="btn btn-outline-danger" 
                    onclick="deleteTask('${task.id}')"
                    data-bs-toggle="tooltip" title="删除任务">
                <i class="fas fa-trash"></i>
            </button>
        `;
    }
    
    buttons += '</div>';
    return buttons;
}

// 渲染分页
function renderPagination() {
    const totalPages = Math.ceil(filteredTasks.length / pageSize);
    const pagination = document.getElementById('tasksPagination');
    
    pagination.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    // 上一页
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一页</a>`;
    pagination.appendChild(prevLi);
    
    // 页码
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(li);
    }
    
    // 下一页
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一页</a>`;
    pagination.appendChild(nextLi);
}

// 切换页面
function changePage(page) {
    const totalPages = Math.ceil(filteredTasks.length / pageSize);
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    renderTasks();
    renderPagination();
}

// 筛选任务
function filterTasks() {
    const typeFilter = document.getElementById('taskTypeFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const priorityFilter = document.getElementById('priorityFilter').value;
    
    filteredTasks = allTasks.filter(task => {
        return (!typeFilter || task.task_type === typeFilter) &&
               (!statusFilter || task.status === statusFilter) &&
               (!priorityFilter || task.priority.toString() === priorityFilter);
    });
    
    currentPage = 1;
    renderTasks();
    renderPagination();
}

// 搜索任务
function searchTasks() {
    const searchTerm = document.getElementById('taskSearch').value.toLowerCase();
    
    if (!searchTerm) {
        filterTasks();
        return;
    }
    
    filteredTasks = allTasks.filter(task => {
        return task.name.toLowerCase().includes(searchTerm) ||
               task.task_type.toLowerCase().includes(searchTerm);
    });
    
    currentPage = 1;
    renderTasks();
    renderPagination();
}

// 刷新任务列表
function refreshTasks() {
    loadTasks();
    showNotification('任务列表已刷新', 'success');
}

// 更新任务参数配置
function updateTaskParams() {
    const taskType = document.getElementById('taskType').value;
    const container = document.getElementById('taskParamsContainer');
    const content = document.getElementById('taskParamsContent');
    
    if (!taskType) {
        container.style.display = 'none';
        return;
    }
    
    // 根据任务类型显示不同的参数配置
    const paramConfigs = {
        'content_fetch': `
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">数据源</label>
                        <select class="form-select" name="source">
                            <option value="netease">网易新闻</option>
                            <option value="sina">新浪新闻</option>
                            <option value="sohu">搜狐新闻</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">采集数量</label>
                        <input type="number" class="form-control" name="count" value="10" min="1" max="100">
                    </div>
                </div>
            </div>
        `,
        'video_editing': `
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">输出分辨率</label>
                        <select class="form-select" name="resolution">
                            <option value="1920x1080">1920x1080</option>
                            <option value="1280x720">1280x720</option>
                            <option value="854x480">854x480</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">帧率</label>
                        <select class="form-select" name="fps">
                            <option value="30">30 FPS</option>
                            <option value="25">25 FPS</option>
                            <option value="24">24 FPS</option>
                        </select>
                    </div>
                </div>
            </div>
        `,
        'video_upload': `
            <div class="mb-3">
                <label class="form-label">上传平台</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="platforms" value="douyin" id="platform-douyin">
                    <label class="form-check-label" for="platform-douyin">抖音</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="platforms" value="bilibili" id="platform-bilibili">
                    <label class="form-check-label" for="platform-bilibili">哔哩哔哩</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="platforms" value="xiaohongshu" id="platform-xiaohongshu">
                    <label class="form-check-label" for="platform-xiaohongshu">小红书</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="platforms" value="kuaishou" id="platform-kuaishou">
                    <label class="form-check-label" for="platform-kuaishou">快手</label>
                </div>
            </div>
        `
    };
    
    content.innerHTML = paramConfigs[taskType] || '';
    container.style.display = taskType ? 'block' : 'none';
}

// 提交创建任务
function submitCreateTask() {
    const form = document.getElementById('createTaskForm');
    const formData = new FormData(form);
    
    // 收集基本信息
    const taskData = {
        name: document.getElementById('taskName').value,
        task_type: document.getElementById('taskType').value,
        priority: parseInt(document.getElementById('taskPriority').value),
        scheduled_time: document.getElementById('scheduledTime').value || null,
        description: document.getElementById('taskDescription').value,
        params: {}
    };
    
    // 验证必填字段
    if (!taskData.name || !taskData.task_type) {
        showNotification('请填写任务名称和类型', 'error');
        return;
    }
    
    // 收集任务参数
    const paramInputs = document.querySelectorAll('#taskParamsContent input, #taskParamsContent select');
    paramInputs.forEach(input => {
        if (input.type === 'checkbox') {
            if (!taskData.params[input.name]) {
                taskData.params[input.name] = [];
            }
            if (input.checked) {
                taskData.params[input.name].push(input.value);
            }
        } else {
            taskData.params[input.name] = input.value;
        }
    });
    
    // 提交任务
    apiRequest('/api/tasks', {
        method: 'POST',
        body: taskData
    })
    .then(data => {
        showNotification('任务创建成功', 'success');
        bootstrap.Modal.getInstance(document.getElementById('createTaskModal')).hide();
        form.reset();
        document.getElementById('taskParamsContainer').style.display = 'none';
        loadTasks();
    })
    .catch(error => {
        showNotification('任务创建失败: ' + error.message, 'error');
    });
}

// 查看任务详情
function viewTaskDetails(taskId) {
    apiRequest(`/api/tasks/${taskId}`)
        .then(task => {
            const content = document.getElementById('taskDetailsContent');
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>基本信息</h6>
                        <table class="table table-sm">
                            <tr><td>任务ID:</td><td>${task.id}</td></tr>
                            <tr><td>任务名称:</td><td>${task.name}</td></tr>
                            <tr><td>任务类型:</td><td>${task.task_type}</td></tr>
                            <tr><td>优先级:</td><td>${getPriorityText(task.priority)}</td></tr>
                            <tr><td>状态:</td><td><span class="status-badge status-${task.status}">${task.status_text}</span></td></tr>
                            <tr><td>进度:</td><td>${task.progress}%</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>时间信息</h6>
                        <table class="table table-sm">
                            <tr><td>创建时间:</td><td>${formatTime(task.created_time)}</td></tr>
                            <tr><td>开始时间:</td><td>${task.started_time ? formatTime(task.started_time) : '未开始'}</td></tr>
                            <tr><td>完成时间:</td><td>${task.completed_time ? formatTime(task.completed_time) : '未完成'}</td></tr>
                            <tr><td>计划时间:</td><td>${task.scheduled_time ? formatTime(task.scheduled_time) : '立即执行'}</td></tr>
                            <tr><td>重试次数:</td><td>${task.retry_count}/${task.max_retries}</td></tr>
                        </table>
                    </div>
                </div>
                
                ${task.params && Object.keys(task.params).length > 0 ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>任务参数</h6>
                        <pre class="bg-light p-3 rounded">${JSON.stringify(task.params, null, 2)}</pre>
                    </div>
                </div>
                ` : ''}
                
                ${task.result ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>执行结果</h6>
                        <pre class="bg-light p-3 rounded">${JSON.stringify(task.result, null, 2)}</pre>
                    </div>
                </div>
                ` : ''}
                
                ${task.error_message ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>错误信息</h6>
                        <div class="alert alert-danger">${task.error_message}</div>
                    </div>
                </div>
                ` : ''}
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('taskDetailsModal'));
            modal.show();
        })
        .catch(error => {
            showNotification('获取任务详情失败: ' + error.message, 'error');
        });
}

// 暂停任务
function pauseTask(taskId) {
    confirmAction('确定要暂停这个任务吗？', () => {
        apiRequest(`/api/tasks/${taskId}`, {
            method: 'PUT',
            body: { status: 'paused' }
        })
        .then(data => {
            showNotification('任务已暂停', 'success');
            loadTasks();
        })
        .catch(error => {
            showNotification('暂停任务失败: ' + error.message, 'error');
        });
    });
}

// 取消任务
function cancelTask(taskId) {
    confirmAction('确定要取消这个任务吗？取消后无法恢复。', () => {
        apiRequest(`/api/tasks/${taskId}`, {
            method: 'PUT',
            body: { status: 'cancelled' }
        })
        .then(data => {
            showNotification('任务已取消', 'success');
            loadTasks();
        })
        .catch(error => {
            showNotification('取消任务失败: ' + error.message, 'error');
        });
    });
}

// 重试任务
function retryTask(taskId) {
    confirmAction('确定要重试这个任务吗？', () => {
        apiRequest(`/api/tasks/${taskId}`, {
            method: 'PUT',
            body: { status: 'pending', retry_count: 0 }
        })
        .then(data => {
            showNotification('任务已重新加入队列', 'success');
            loadTasks();
        })
        .catch(error => {
            showNotification('重试任务失败: ' + error.message, 'error');
        });
    });
}

// 删除任务
function deleteTask(taskId) {
    confirmAction('确定要删除这个任务吗？删除后无法恢复。', () => {
        apiRequest(`/api/tasks/${taskId}`, {
            method: 'DELETE'
        })
        .then(data => {
            showNotification('任务已删除', 'success');
            loadTasks();
        })
        .catch(error => {
            showNotification('删除任务失败: ' + error.message, 'error');
        });
    });
}

// 显示任务统计
function showTaskStatistics() {
    apiRequest('/api/tasks/statistics')
        .then(data => {
            const content = document.getElementById('taskStatisticsContent');
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>每日任务统计</h6>
                        <canvas id="dailyTasksChart" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h6>任务类型分布</h6>
                        <canvas id="taskTypeChart" height="200"></canvas>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <h6>任务执行统计</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>任务类型</th>
                                        <th>总数</th>
                                        <th>完成数</th>
                                        <th>成功率</th>
                                        <th>平均耗时</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.task_type_stats.map(stat => `
                                        <tr>
                                            <td>${stat.task_type}</td>
                                            <td>${stat.count}</td>
                                            <td>${stat.completed_count}</td>
                                            <td>${stat.success_rate.toFixed(1)}%</td>
                                            <td>${stat.avg_duration ? (stat.avg_duration / 60).toFixed(1) + '分钟' : '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // 绘制图表
            drawTaskStatisticsCharts(data);
            
            const modal = new bootstrap.Modal(document.getElementById('taskStatisticsModal'));
            modal.show();
        })
        .catch(error => {
            showNotification('获取任务统计失败: ' + error.message, 'error');
        });
}

// 绘制任务统计图表
function drawTaskStatisticsCharts(data) {
    // 每日任务统计图表
    const dailyCtx = document.getElementById('dailyTasksChart').getContext('2d');
    new Chart(dailyCtx, {
        type: 'line',
        data: {
            labels: data.daily_stats.map(stat => stat.date),
            datasets: [
                {
                    label: '总任务数',
                    data: data.daily_stats.map(stat => stat.total_tasks),
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                },
                {
                    label: '完成任务数',
                    data: data.daily_stats.map(stat => stat.completed_tasks),
                    borderColor: 'rgb(54, 162, 235)',
                    tension: 0.1
                },
                {
                    label: '失败任务数',
                    data: data.daily_stats.map(stat => stat.failed_tasks),
                    borderColor: 'rgb(255, 99, 132)',
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    // 任务类型分布图表
    const typeCtx = document.getElementById('taskTypeChart').getContext('2d');
    new Chart(typeCtx, {
        type: 'doughnut',
        data: {
            labels: data.task_type_stats.map(stat => stat.task_type),
            datasets: [{
                data: data.task_type_stats.map(stat => stat.count),
                backgroundColor: [
                    'rgb(255, 99, 132)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 205, 86)',
                    'rgb(75, 192, 192)',
                    'rgb(153, 102, 255)',
                    'rgb(255, 159, 64)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// 加载任务统计（用于卡片显示）
function loadTaskStatistics() {
    apiRequest('/api/dashboard/stats')
        .then(data => {
            document.getElementById('total-tasks').textContent = data.today_tasks || 0;
            document.getElementById('running-tasks').textContent = data.running_tasks || 0;
            document.getElementById('completed-tasks').textContent = data.completed_tasks || 0;
            document.getElementById('failed-tasks').textContent = data.failed_tasks || 0;
        })
        .catch(error => {
            console.error('加载任务统计失败:', error);
        });
}

// 获取优先级文本
function getPriorityText(priority) {
    const priorityMap = {
        1: '低',
        2: '普通',
        3: '高',
        4: '紧急'
    };
    return priorityMap[priority] || '普通';
}

// Socket.IO事件监听
socket.on('task_update', function(data) {
    // 更新任务状态
    const taskIndex = allTasks.findIndex(task => task.id === data.task_id);
    if (taskIndex !== -1) {
        allTasks[taskIndex].status = data.status;
        allTasks[taskIndex].progress = data.progress;
        allTasks[taskIndex].status_text = data.status_text;
        
        // 更新界面
        updateTaskRow(allTasks[taskIndex]);
        updateTaskStatistics();
    }
});

socket.on('task_created', function(data) {
    // 新任务创建，重新加载列表
    loadTasks();
});

socket.on('task_completed', function(data) {
    // 任务完成，更新统计
    loadTaskStatistics();
});
</script>
{% endblock %}
