{% extends "base.html" %}

{% block title %}系统日志 - 视频自动化系统{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">系统日志</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshLogs()">
                    <i class="fas fa-sync-alt"></i> 刷新
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
                    <i class="fas fa-trash"></i> 清空日志
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="downloadLogs()">
                    <i class="fas fa-download"></i> 下载日志
                </button>
            </div>
        </div>
    </div>

    <!-- 日志文件列表 -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">日志文件</h6>
                </div>
                <div class="card-body">
                    {% if log_files %}
                    <div class="list-group">
                        {% for log_file in log_files %}
                        <a href="#" class="list-group-item list-group-item-action" onclick="loadLogFile('{{ log_file.name }}')">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ log_file.name }}</h6>
                                <small>{{ log_file.modified }}</small>
                            </div>
                            <p class="mb-1">大小: {{ "%.2f"|format(log_file.size / 1024) }} KB</p>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-file-alt fa-3x text-gray-300 mb-3"></i>
                        <p class="text-muted">暂无日志文件</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">实时日志</h6>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                        <label class="form-check-label" for="autoRefresh">自动刷新</label>
                    </div>
                </div>
                <div class="card-body">
                    <div id="logContent" class="log-content" style="height: 400px; overflow-y: auto; background-color: #1a1a1a; color: #00ff00; font-family: 'Courier New', monospace; padding: 15px; border-radius: 5px;">
                        {% if recent_logs %}
                        {% for log in recent_logs %}
                        <div class="log-entry">
                            <span class="log-timestamp">[{{ log.timestamp }}]</span>
                            <span class="log-level log-level-{{ log.level.lower() }}">[{{ log.level }}]</span>
                            <span class="log-message">{{ log.message }}</span>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">暂无日志记录</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 日志过滤器 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">日志过滤</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="logLevel" class="form-label">日志级别</label>
                            <select class="form-select" id="logLevel" onchange="filterLogs()">
                                <option value="">全部</option>
                                <option value="DEBUG">DEBUG</option>
                                <option value="INFO">INFO</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                                <option value="CRITICAL">CRITICAL</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="startDate" class="form-label">开始时间</label>
                            <input type="datetime-local" class="form-control" id="startDate" onchange="filterLogs()">
                        </div>
                        <div class="col-md-3">
                            <label for="endDate" class="form-label">结束时间</label>
                            <input type="datetime-local" class="form-control" id="endDate" onchange="filterLogs()">
                        </div>
                        <div class="col-md-3">
                            <label for="searchKeyword" class="form-label">关键词搜索</label>
                            <input type="text" class="form-control" id="searchKeyword" placeholder="输入搜索关键词" onkeyup="filterLogs()">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 日志统计 -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">日志统计</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="h4 mb-0 font-weight-bold text-primary" id="debugCount">0</div>
                                <div class="text-xs font-weight-bold text-uppercase">DEBUG</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="h4 mb-0 font-weight-bold text-info" id="infoCount">0</div>
                                <div class="text-xs font-weight-bold text-uppercase">INFO</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="h4 mb-0 font-weight-bold text-warning" id="warningCount">0</div>
                                <div class="text-xs font-weight-bold text-uppercase">WARNING</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="h4 mb-0 font-weight-bold text-danger" id="errorCount">0</div>
                                <div class="text-xs font-weight-bold text-uppercase">ERROR</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="h4 mb-0 font-weight-bold text-dark" id="criticalCount">0</div>
                                <div class="text-xs font-weight-bold text-uppercase">CRITICAL</div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <div class="h4 mb-0 font-weight-bold text-secondary" id="totalCount">0</div>
                                <div class="text-xs font-weight-bold text-uppercase">总计</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.log-content {
    font-size: 12px;
    line-height: 1.4;
}

.log-entry {
    margin-bottom: 2px;
    word-wrap: break-word;
}

.log-timestamp {
    color: #888;
}

.log-level {
    font-weight: bold;
    margin: 0 5px;
}

.log-level-debug { color: #6c757d; }
.log-level-info { color: #17a2b8; }
.log-level-warning { color: #ffc107; }
.log-level-error { color: #dc3545; }
.log-level-critical { color: #e83e8c; }

.log-message {
    color: #00ff00;
}
</style>

<script>
let autoRefreshInterval;
let allLogs = [];

// 刷新日志
function refreshLogs() {
    showLoading('正在刷新日志...');
    
    fetch('/api/logs/recent')
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            allLogs = data.logs;
            displayLogs(allLogs);
            updateLogStats(allLogs);
        } else {
            showAlert('error', '刷新失败: ' + data.error);
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('error', '刷新失败: ' + error.message);
    });
}

// 显示日志
function displayLogs(logs) {
    const logContent = document.getElementById('logContent');
    logContent.innerHTML = '';
    
    if (logs.length === 0) {
        logContent.innerHTML = '<div class="text-center py-4"><p class="text-muted">暂无日志记录</p></div>';
        return;
    }
    
    logs.forEach(log => {
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.innerHTML = `
            <span class="log-timestamp">[${log.timestamp}]</span>
            <span class="log-level log-level-${log.level.toLowerCase()}">[${log.level}]</span>
            <span class="log-message">${log.message}</span>
        `;
        logContent.appendChild(logEntry);
    });
    
    // 滚动到底部
    logContent.scrollTop = logContent.scrollHeight;
}

// 更新日志统计
function updateLogStats(logs) {
    const stats = {
        DEBUG: 0,
        INFO: 0,
        WARNING: 0,
        ERROR: 0,
        CRITICAL: 0
    };
    
    logs.forEach(log => {
        if (stats.hasOwnProperty(log.level)) {
            stats[log.level]++;
        }
    });
    
    document.getElementById('debugCount').textContent = stats.DEBUG;
    document.getElementById('infoCount').textContent = stats.INFO;
    document.getElementById('warningCount').textContent = stats.WARNING;
    document.getElementById('errorCount').textContent = stats.ERROR;
    document.getElementById('criticalCount').textContent = stats.CRITICAL;
    document.getElementById('totalCount').textContent = logs.length;
}

// 过滤日志
function filterLogs() {
    const level = document.getElementById('logLevel').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const keyword = document.getElementById('searchKeyword').value.toLowerCase();
    
    let filteredLogs = allLogs.filter(log => {
        // 级别过滤
        if (level && log.level !== level) {
            return false;
        }
        
        // 时间过滤
        if (startDate && log.timestamp < startDate) {
            return false;
        }
        if (endDate && log.timestamp > endDate) {
            return false;
        }
        
        // 关键词过滤
        if (keyword && !log.message.toLowerCase().includes(keyword)) {
            return false;
        }
        
        return true;
    });
    
    displayLogs(filteredLogs);
    updateLogStats(filteredLogs);
}

// 加载日志文件
function loadLogFile(filename) {
    showLoading('正在加载日志文件...');
    
    fetch(`/api/logs/file/${filename}`)
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            allLogs = data.logs;
            displayLogs(allLogs);
            updateLogStats(allLogs);
        } else {
            showAlert('error', '加载失败: ' + data.error);
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('error', '加载失败: ' + error.message);
    });
}

// 清空日志
function clearLogs() {
    if (!confirm('确定要清空所有日志吗？此操作不可恢复。')) {
        return;
    }
    
    showLoading('正在清空日志...');
    
    fetch('/api/logs/clear', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showAlert('success', '日志清空成功！');
            refreshLogs();
        } else {
            showAlert('error', '清空失败: ' + data.error);
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('error', '清空失败: ' + error.message);
    });
}

// 下载日志
function downloadLogs() {
    showLoading('正在准备下载...');
    
    fetch('/api/logs/download', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            const link = document.createElement('a');
            link.href = data.download_url;
            link.download = data.filename;
            link.click();
            showAlert('success', '下载开始！');
        } else {
            showAlert('error', '下载失败: ' + data.error);
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('error', '下载失败: ' + error.message);
    });
}

// 自动刷新
function toggleAutoRefresh() {
    const autoRefresh = document.getElementById('autoRefresh');
    
    if (autoRefresh.checked) {
        autoRefreshInterval = setInterval(refreshLogs, 5000); // 每5秒刷新
    } else {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 初始化日志数据
    allLogs = {% if recent_logs %}{{ recent_logs | tojson | safe }}{% else %}[]{% endif %};
    if (!allLogs || !Array.isArray(allLogs)) {
        allLogs = [];
    }
    updateLogStats(allLogs);
    
    // 设置自动刷新
    document.getElementById('autoRefresh').addEventListener('change', toggleAutoRefresh);
    toggleAutoRefresh();
    
    // 设置默认时间范围（最近24小时）
    const now = new Date();
    const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    
    document.getElementById('startDate').value = yesterday.toISOString().slice(0, 16);
    document.getElementById('endDate').value = now.toISOString().slice(0, 16);
});

// 页面卸载时清理定时器
window.addEventListener('beforeunload', function() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
});
</script>
{% endblock %}