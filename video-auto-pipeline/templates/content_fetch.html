{% extends "base.html" %}

{% block title %}内容采集 - 视频搬运矩阵自动化系统{% endblock %}

{% block extra_css %}
<style>
.source-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.source-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.source-card.disabled {
    opacity: 0.6;
}

.source-toggle {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 10;
}

.task-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.task-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.platform-badge {
    background: #28a745;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
}

.category-badge {
    background: #007bff;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
}

.task-progress {
    height: 8px;
    border-radius: 10px;
    background-color: rgba(255, 255, 255, 0.2);
}

.task-progress .progress-bar {
    border-radius: 10px;
    background: linear-gradient(90deg, #00d4ff 0%, #090979 100%);
}

.chart-container {
    height: 200px;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-download"></i>
        内容采集
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-outline-secondary" onclick="refreshPage()">
                <i class="fas fa-sync-alt"></i> 刷新
            </button>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                <i class="fas fa-plus"></i> 创建采集任务
            </button>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addSourceModal">
                <i class="fas fa-plus-circle"></i> 添加采集源
            </button>
        </div>
    </div>
</div>

<!-- 统计卡片 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ sources|length }}</h4>
                        <p class="card-text">采集源总数</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-rss fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ enabled_sources }}</h4>
                        <p class="card-text">启用的采集源</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ tasks|length }}</h4>
                        <p class="card-text">采集任务总数</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-tasks fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ running_tasks }}</h4>
                        <p class="card-text">运行中的任务</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-play-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 统计图表 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">平台分布</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="platformChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">分类分布</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 内容标签页 -->
<ul class="nav nav-tabs mb-3" id="contentTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="sources-tab" data-bs-toggle="tab" data-bs-target="#sources" type="button" role="tab">
            <i class="fas fa-rss"></i> 采集源管理
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab">
            <i class="fas fa-tasks"></i> 采集任务
        </button>
    </li>
</ul>

<div class="tab-content" id="contentTabsContent">
    <!-- 采集源管理标签页 -->
    <div class="tab-pane fade show active" id="sources" role="tabpanel">
        <!-- 筛选器 -->
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="platformFilter" class="form-label">平台筛选</label>
                                <select class="form-select" id="platformFilter" onchange="filterSources()">
                                    <option value="">全部平台</option>
                                    {% for platform, count in platform_stats.items() %}
                                    <option value="{{ platform }}">{{ platform }} ({{ count }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="categoryFilter" class="form-label">分类筛选</label>
                                <select class="form-select" id="categoryFilter" onchange="filterSources()">
                                    <option value="">全部分类</option>
                                    {% for category, count in category_stats.items() %}
                                    <option value="{{ category }}">{{ category }} ({{ count }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="statusFilter" class="form-label">状态筛选</label>
                                <select class="form-select" id="statusFilter" onchange="filterSources()">
                                    <option value="">全部状态</option>
                                    <option value="enabled">已启用</option>
                                    <option value="disabled">已禁用</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="sourceSearch" class="form-label">搜索</label>
                                <input type="text" class="form-control" id="sourceSearch" placeholder="输入名称或URL..." onkeyup="filterSources()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 采集源列表 -->
        <div class="row" id="sourcesList">
            {% for source in sources %}
            <div class="col-md-4 source-item" 
                 data-platform="{{ source.platform }}" 
                 data-category="{{ source.category }}" 
                 data-status="{{ 'enabled' if source.enabled else 'disabled' }}">
                <div class="source-card {{ 'disabled' if not source.enabled }}">
                    <div class="card-body position-relative">
                        <div class="source-toggle form-check form-switch">
                            <input class="form-check-input" type="checkbox" 
                                   {{ 'checked' if source.enabled else '' }}
                                   onchange="toggleSource({{ source.id }}, this.checked)">
                        </div>
                        
                        <h5 class="card-title">{{ source.name }}</h5>
                        
                        <div class="mb-2">
                            <span class="platform-badge me-1">{{ source.platform }}</span>
                            <span class="category-badge">{{ source.category }}</span>
                        </div>
                        
                        <p class="text-muted small mb-2">{{ source.description }}</p>
                        
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-link"></i> <a href="{{ source.url }}" target="_blank">{{ source.url }}</a>
                            </small>
                        </div>
                        
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> 采集间隔: {{ source.fetch_interval }} 分钟
                            </small>
                        </div>
                        
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-list-ol"></i> 采集数量: {{ source.fetch_limit }} 条
                            </small>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <small class="text-muted">
                                <i class="fas fa-calendar-alt"></i> {{ source.created_at.split('T')[0] if source.created_at else '' }}
                            </small>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editSource({{ source.id }})" title="编辑">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="testSource({{ source.id }})" title="测试">
                                    <i class="fas fa-vial"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="createTaskFromSource({{ source.id }})" title="创建任务">
                                    <i class="fas fa-play"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- 无采集源提示 -->
        {% if not sources %}
        <div class="text-center py-5">
            <i class="fas fa-rss fa-3x text-muted mb-3"></i>
            <h4>暂无采集源</h4>
            <p class="text-muted">点击"添加采集源"按钮添加新的内容采集源</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSourceModal">
                <i class="fas fa-plus-circle"></i> 添加采集源
            </button>
        </div>
        {% endif %}
    </div>
    
    <!-- 采集任务标签页 -->
    <div class="tab-pane fade" id="tasks" role="tabpanel">
        <!-- 任务列表 -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>任务名称</th>
                        <th>采集源</th>
                        <th>分类</th>
                        <th>限制</th>
                        <th>状态</th>
                        <th>进度</th>
                        <th>结果数</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr data-task-id="{{ task.id }}">
                        <td>{{ task.id }}</td>
                        <td>{{ task.task_name }}</td>
                        <td>
                            <span class="badge bg-primary">{{ task.source_ids|length }} 个源</span>
                        </td>
                        <td>
                            {% if task.category_filters %}
                                {% for category in task.category_filters %}
                                <span class="badge bg-info">{{ category }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="badge bg-secondary">全部</span>
                            {% endif %}
                        </td>
                        <td>{{ task.total_limit }} 条</td>
                        <td>
                            <span class="status-badge status-{{ task.status }}">
                                {{ {'pending': '等待中', 'running': '运行中', 'completed': '已完成', 'failed': '失败', 'stopped': '已停止'}[task.status] }}
                            </span>
                        </td>
                        <td>
                            <div class="progress task-progress">
                                <div class="progress-bar task-progress-bar" role="progressbar" 
                                     style="width: {{ task.progress }}%;" 
                                     aria-valuenow="{{ task.progress }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ task.progress }}%
                                </div>
                            </div>
                        </td>
                        <td>{{ task.result_count or 0 }}</td>
                        <td>{{ task.created_at.split('T')[0] if task.created_at else '' }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                {% if task.status == 'pending' %}
                                <button class="btn btn-outline-success" onclick="startTask({{ task.id }})" title="启动">
                                    <i class="fas fa-play"></i>
                                </button>
                                {% elif task.status == 'running' %}
                                <button class="btn btn-outline-warning" onclick="stopTask({{ task.id }})" title="停止">
                                    <i class="fas fa-stop"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-info" onclick="viewTaskDetails({{ task.id }})" title="详情">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteTask({{ task.id }})" title="删除">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- 无任务提示 -->
        {% if not tasks %}
        <div class="text-center py-5">
            <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
            <h4>暂无采集任务</h4>
            <p class="text-muted">点击"创建采集任务"按钮创建新的内容采集任务</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                <i class="fas fa-plus"></i> 创建采集任务
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- 添加采集源模态框 -->
<div class="modal fade" id="addSourceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">添加采集源</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addSourceForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="sourceName" class="form-label">名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="sourceName" required>
                        </div>
                        <div class="col-md-6">
                            <label for="sourcePlatform" class="form-label">平台 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="sourcePlatform" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sourceUrl" class="form-label">URL <span class="text-danger">*</span></label>
                        <input type="url" class="form-control" id="sourceUrl" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sourceDescription" class="form-label">描述</label>
                        <textarea class="form-control" id="sourceDescription" rows="2"></textarea>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="sourceCategory" class="form-label">分类 <span class="text-danger">*</span></label>
                            <select class="form-select" id="sourceCategory" required>
                                <option value="">选择分类...</option>
                                {% for category in categories %}
                                <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="sourceFetchLimit" class="form-label">采集数量</label>
                            <input type="number" class="form-control" id="sourceFetchLimit" value="20" min="1" max="100">
                        </div>
                        <div class="col-md-4">
                            <label for="sourceFetchInterval" class="form-label">采集间隔(分钟)</label>
                            <input type="number" class="form-control" id="sourceFetchInterval" value="60" min="5">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="addSource()">
                    <i class="fas fa-plus-circle"></i> 添加
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 创建采集任务模态框 -->
<div class="modal fade" id="createTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">创建采集任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createTaskForm">
                    <div class="mb-3">
                        <label for="taskName" class="form-label">任务名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="taskName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">选择采集源 <span class="text-danger">*</span></label>
                        <div class="source-selection" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px;">
                            {% for source in sources %}
                            {% if source.enabled %}
                            <div class="form-check">
                                <input class="form-check-input source-checkbox" type="checkbox" value="{{ source.id }}" id="source{{ source.id }}">
                                <label class="form-check-label" for="source{{ source.id }}">
                                    {{ source.name }} ({{ source.platform }})
                                </label>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">选择分类过滤</label>
                        <div class="category-selection" style="max-height: 150px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px;">
                            {% for category in categories %}
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" value="{{ category }}" id="category{{ loop.index }}">
                                <label class="form-check-label" for="category{{ loop.index }}">
                                    {{ category }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="totalLimit" class="form-label">总采集数量限制</label>
                        <input type="number" class="form-control" id="totalLimit" value="50" min="1" max="1000">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="createTask()">
                    <i class="fas fa-plus"></i> 创建
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 测试采集源结果模态框 -->
<div class="modal fade" id="testResultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">测试采集结果</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="testResultContent">
                    <!-- 测试结果将在这里显示 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

    <!-- 任务详情模态框 -->
    <div class="modal fade" id="taskDetailModal" tabindex="-1" aria-labelledby="taskDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskDetailModalLabel">任务详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="taskDetailContent">
                        <!-- 任务详情将在这里显示 -->
                    </div>
                    
                    <div class="mt-4">
                        <h6>采集结果</h6>
                        <div id="taskResults" class="mt-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p>正在加载采集结果...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    // 初始化图表
    initCharts();
    
    // 设置定时刷新任务状态
    setInterval(refreshTaskStatus, 5000);
});

// 初始化图表
function initCharts() {
    // 平台分布图表
    const platformCtx = document.getElementById('platformChart').getContext('2d');
    const platformData = {
        labels: Object.keys({{ platform_stats|tojson }}),
        datasets: [{
            data: Object.values({{ platform_stats|tojson }}),
            backgroundColor: [
                '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
                '#5a5c69', '#858796', '#6f42c1', '#20c9a6', '#fd7e14'
            ],
            hoverBackgroundColor: [
                '#2e59d9', '#17a673', '#2c9faf', '#f4b619', '#e02d1b',
                '#4e4f52', '#717384', '#5d36a4', '#1aa88a', '#e76b00'
            ],
            hoverBorderColor: "rgba(234, 236, 244, 1)",
        }]
    };
    
    new Chart(platformCtx, {
        type: 'doughnut',
        data: platformData,
        options: {
            maintainAspectRatio: false,
            tooltips: {
                backgroundColor: "rgb(255,255,255)",
                bodyFontColor: "#858796",
                borderColor: '#dddfeb',
                borderWidth: 1,
                xPadding: 15,
                yPadding: 15,
                displayColors: false,
                caretPadding: 10,
            },
            legend: {
                display: true,
                position: 'right'
            },
            cutoutPercentage: 70,
        },
    });
    
    // 分类分布图表
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryData = {
        labels: Object.keys({{ category_stats|tojson }}),
        datasets: [{
            data: Object.values({{ category_stats|tojson }}),
            backgroundColor: [
                '#1cc88a', '#4e73df', '#36b9cc', '#f6c23e', '#e74a3b',
                '#5a5c69', '#858796', '#6f42c1', '#20c9a6', '#fd7e14'
            ],
            hoverBackgroundColor: [
                '#17a673', '#2e59d9', '#2c9faf', '#f4b619', '#e02d1b',
                '#4e4f52', '#717384', '#5d36a4', '#1aa88a', '#e76b00'
            ],
            hoverBorderColor: "rgba(234, 236, 244, 1)",
        }]
    };
    
    new Chart(categoryCtx, {
        type: 'doughnut',
        data: categoryData,
        options: {
            maintainAspectRatio: false,
            tooltips: {
                backgroundColor: "rgb(255,255,255)",
                bodyFontColor: "#858796",
                borderColor: '#dddfeb',
                borderWidth: 1,
                xPadding: 15,
                yPadding: 15,
                displayColors: false,
                caretPadding: 10,
            },
            legend: {
                display: true,
                position: 'right'
            },
            cutoutPercentage: 70,
        },
    });
}

// 刷新任务状态
function refreshTaskStatus() {
    fetch('/api/content-fetch/task-status')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                data.tasks.forEach(task => {
                    updateTaskUI(task);
                });
            }
        })
        .catch(error => console.error('刷新任务状态失败:', error));
}

// 更新任务UI
function updateTaskUI(task) {
    const row = document.querySelector(`tr[data-task-id="${task.id}"]`);
    if (!row) return;
    
    // 更新状态
    const statusCell = row.querySelector('td:nth-child(6) .status-badge');
    if (statusCell) {
        statusCell.className = `status-badge status-${task.status}`;
        statusCell.textContent = {
            'pending': '等待中',
            'running': '运行中',
            'completed': '已完成',
            'failed': '失败',
            'stopped': '已停止'
        }[task.status] || task.status;
    }
    
    // 更新进度条
    const progressBar = row.querySelector('.task-progress-bar');
    if (progressBar) {
        progressBar.style.width = `${task.progress}%`;
        progressBar.setAttribute('aria-valuenow', task.progress);
        progressBar.textContent = `${task.progress}%`;
    }
    
    // 更新结果数
    const resultCell = row.querySelector('td:nth-child(8)');
    if (resultCell) {
        resultCell.textContent = task.result_count || 0;
    }
    
    // 更新操作按钮
    const actionCell = row.querySelector('td:nth-child(10) .btn-group');
    if (actionCell) {
        // 清除现有按钮
        actionCell.innerHTML = '';
        
        // 根据状态添加不同的按钮
        if (task.status === 'pending') {
            actionCell.innerHTML += `
                <button class="btn btn-outline-success" onclick="startTask(${task.id})" title="启动">
                    <i class="fas fa-play"></i>
                </button>
            `;
        } else if (task.status === 'running') {
            actionCell.innerHTML += `
                <button class="btn btn-outline-warning" onclick="stopTask(${task.id})" title="停止">
                    <i class="fas fa-stop"></i>
                </button>
            `;
        }
        
        // 添加详情和删除按钮
        actionCell.innerHTML += `
            <button class="btn btn-outline-info" onclick="viewTaskDetails(${task.id})" title="详情">
                <i class="fas fa-info-circle"></i>
            </button>
            <button class="btn btn-outline-danger" onclick="deleteTask(${task.id})" title="删除">
                <i class="fas fa-trash"></i>
            </button>
        `;
    }
}

// 刷新页面
function refreshPage() {
    window.location.reload();
}

// 筛选采集源
function filterSources() {
    const platform = document.getElementById('platformFilter').value;
    const category = document.getElementById('categoryFilter').value;
    const status = document.getElementById('statusFilter').value;
    const search = document.getElementById('sourceSearch').value.toLowerCase();
    
    const sources = document.querySelectorAll('.source-item');
    
    sources.forEach(source => {
        const sourcePlatform = source.dataset.platform;
        const sourceCategory = source.dataset.category;
        const sourceStatus = source.dataset.status;
        const sourceText = source.textContent.toLowerCase();
        
        const platformMatch = !platform || sourcePlatform === platform;
        const categoryMatch = !category || sourceCategory === category;
        const statusMatch = !status || sourceStatus === status;
        const searchMatch = !search || sourceText.includes(search);
        
        if (platformMatch && categoryMatch && statusMatch && searchMatch) {
            source.style.display = '';
        } else {
            source.style.display = 'none';
        }
    });
}

// 显示任务详情
function displayTaskDetails(task) {
    const modal = document.getElementById('taskDetailModal');
    const content = document.getElementById('taskDetailContent');
    
    // 构建详情HTML
    let html = `
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">${task.task_name}</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>ID:</strong> ${task.id}</p>
                        <p><strong>状态:</strong> 
                            <span class="badge bg-${getStatusBadgeClass(task.status)}">
                                ${getStatusText(task.status)}
                            </span>
                        </p>
                        <p><strong>进度:</strong> ${task.progress}%</p>
                        <p><strong>采集结果数:</strong> ${task.result_count || 0}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>创建时间:</strong> ${formatDateTime(task.created_at)}</p>
                        <p><strong>更新时间:</strong> ${formatDateTime(task.updated_at)}</p>
                        <p><strong>总采集限制:</strong> ${task.total_limit} 条</p>
                    </div>
                </div>
                
                <h6>采集源:</h6>
                <div class="source-list mb-3">
                    ${task.source_ids.map(id => `<span class="badge bg-primary me-1">ID: ${id}</span>`).join('')}
                </div>
                
                <h6>分类过滤:</h6>
                <div class="category-list mb-3">
                    ${task.category_filters && task.category_filters.length > 0 
                        ? task.category_filters.map(cat => `<span class="badge bg-info me-1">${cat}</span>`).join('')
                        : '<span class="badge bg-secondary">全部分类</span>'}
                </div>
                
                <div class="progress mb-3">
                    <div class="progress-bar" role="progressbar" style="width: ${task.progress}%;" 
                         aria-valuenow="${task.progress}" aria-valuemin="0" aria-valuemax="100">
                        ${task.progress}%
                    </div>
                </div>
            </div>
        </div>
        
        <h5>采集结果预览</h5>
        <div id="resultPreview">
            <div class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在加载采集结果...</p>
            </div>
        </div>
    `;
    
    content.innerHTML = html;
    
    // 获取采集结果预览
    fetch(`/api/content-fetch/task-results/${task.id}?limit=5`)
        .then(response => response.json())
        .then(data => {
            const previewDiv = document.getElementById('resultPreview');
            
            if (data.success && data.results && data.results.length > 0) {
                let resultsHtml = '<div class="list-group">';
                
                data.results.forEach(result => {
                    resultsHtml += `
                        <div class="list-group-item">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${result.title}</h6>
                                <small class="text-muted">${result.category}</small>
                            </div>
                            <p class="mb-1">${result.content.substring(0, 100)}${result.content.length > 100 ? '...' : ''}</p>
                            <small class="text-muted">
                                <a href="${result.source_url}" target="_blank">${result.source_url}</a>
                            </small>
                        </div>
                    `;
                });
                
                resultsHtml += '</div>';
                previewDiv.innerHTML = resultsHtml;
            } else {
                previewDiv.innerHTML = '<div class="alert alert-info">暂无采集结果</div>';
            }
        })
        .catch(error => {
            console.error('获取采集结果失败:', error);
            document.getElementById('resultPreview').innerHTML = 
                '<div class="alert alert-danger">获取采集结果失败</div>';
        });
}

// 获取状态对应的Badge类
function getStatusBadgeClass(status) {
    const statusMap = {
        'pending': 'secondary',
        'running': 'primary',
        'completed': 'success',
        'failed': 'danger',
        'stopped': 'warning'
    };
    return statusMap[status] || 'secondary';
}

// 获取状态文本
function getStatusText(status) {
    const statusMap = {
        'pending': '等待中',
        'running': '运行中',
        'completed': '已完成',
        'failed': '失败',
        'stopped': '已停止'
    };
    return statusMap[status] || status;
}

// 格式化日期时间
function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return '未知';
    
    try {
        const date = new Date(dateTimeStr);
        return date.toLocaleString('zh-CN');
    } catch (e) {
        return dateTimeStr;
    }
}

// 切换采集源状态
function toggleSource(sourceId, enabled) {
    fetch(`/api/content-fetch/toggle-source/${sourceId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ enabled: enabled })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const sourceCard = document.querySelector(`.source-item[data-source-id="${sourceId}"] .source-card`);
            if (sourceCard) {
                if (enabled) {
                    sourceCard.classList.remove('disabled');
                    sourceCard.closest('.source-item').setAttribute('data-status', 'enabled');
                } else {
                    sourceCard.classList.add('disabled');
                    sourceCard.closest('.source-item').setAttribute('data-status', 'disabled');
                }
            }
            showToast('成功', `采集源已${enabled ? '启用' : '禁用'}`);
        } else {
            showToast('错误', data.message || '操作失败', 'error');
            // 恢复开关状态
            const toggle = document.querySelector(`.source-item[data-source-id="${sourceId}"] .source-toggle input`);
            if (toggle) toggle.checked = !enabled;
        }
    })
    .catch(error => {
        console.error('切换采集源状态失败:', error);
        showToast('错误', '网络错误，请重试', 'error');
        // 恢复开关状态
        const toggle = document.querySelector(`.source-item[data-source-id="${sourceId}"] .source-toggle input`);
        if (toggle) toggle.checked = !enabled;
    });
}

// 添加采集源
function addSource() {
    const form = document.getElementById('addSourceForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const sourceData = {
        name: document.getElementById('sourceName').value,
        platform: document.getElementById('sourcePlatform').value,
        url: document.getElementById('sourceUrl').value,
        description: document.getElementById('sourceDescription').value,
        category: document.getElementById('sourceCategory').value,
        fetch_limit: parseInt(document.getElementById('sourceFetchLimit').value),
        fetch_interval: parseInt(document.getElementById('sourceFetchInterval').value),
        enabled: true
    };
    
    fetch('/api/content-fetch/add-source', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(sourceData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('成功', '采集源添加成功');
            // 关闭模态框并刷新页面
            const modal = bootstrap.Modal.getInstance(document.getElementById('addSourceModal'));
            modal.hide();
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast('错误', data.message || '添加失败', 'error');
        }
    })
    .catch(error => {
        console.error('添加采集源失败:', error);
        showToast('错误', '网络错误，请重试', 'error');
    });
}

// 编辑采集源
function editSource(sourceId) {
    // 获取采集源数据
    fetch(`/api/content-fetch/sources/${sourceId}/detail`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const source = data.source;
                
                // 填充表单
                document.getElementById('sourceName').value = source.name;
                document.getElementById('sourcePlatform').value = source.platform;
                document.getElementById('sourceUrl').value = source.url;
                document.getElementById('sourceDescription').value = source.description;
                document.getElementById('sourceCategory').value = source.category;
                document.getElementById('sourceFetchLimit').value = source.fetch_limit;
                document.getElementById('sourceFetchInterval').value = source.fetch_interval;
                
                // 修改模态框标题和按钮
                document.querySelector('#addSourceModal .modal-title').textContent = '编辑采集源';
                document.querySelector('#addSourceModal .modal-footer .btn-primary').textContent = '保存';
                document.querySelector('#addSourceModal .modal-footer .btn-primary').onclick = function() {
                    updateSource(sourceId);
                };
                
                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('addSourceModal'));
                modal.show();
            } else {
                showToast('错误', data.message || '获取采集源数据失败', 'error');
            }
        })
        .catch(error => {
            console.error('获取采集源数据失败:', error);
            showToast('错误', '网络错误，请重试', 'error');
        });
}

// 更新采集源
function updateSource(sourceId) {
    const form = document.getElementById('addSourceForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const sourceData = {
        name: document.getElementById('sourceName').value,
        platform: document.getElementById('sourcePlatform').value,
        url: document.getElementById('sourceUrl').value,
        description: document.getElementById('sourceDescription').value,
        category: document.getElementById('sourceCategory').value,
        fetch_limit: parseInt(document.getElementById('sourceFetchLimit').value),
        fetch_interval: parseInt(document.getElementById('sourceFetchInterval').value)
    };
    
    fetch(`/api/content-fetch/update-source/${sourceId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(sourceData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('成功', '采集源更新成功');
            // 关闭模态框并刷新页面
            const modal = bootstrap.Modal.getInstance(document.getElementById('addSourceModal'));
            modal.hide();
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast('错误', data.message || '更新失败', 'error');
        }
    })
    .catch(error => {
        console.error('更新采集源失败:', error);
        showToast('错误', '网络错误，请重试', 'error');
    });
}

// 测试采集源
function testSource(sourceId) {
    showToast('信息', '正在测试采集源，请稍候...', 'info');
    
    fetch(`/api/content-fetch/test-source/${sourceId}`, {
        method: 'POST'
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 显示测试结果
                const resultContent = document.getElementById('testResultContent');
                
                if (data.results && data.results.length > 0) {
                    let html = '<div class="alert alert-success">测试成功，共获取 ' + data.results.length + ' 条内容</div>';
                    html += '<div class="table-responsive"><table class="table table-striped">';
                    html += '<thead><tr><th>标题</th><th>链接</th><th>发布时间</th></tr></thead>';
                    html += '<tbody>';
                    
                    data.results.forEach(item => {
                        html += '<tr>';
                        html += '<td>' + (item.title || '无标题') + '</td>';
                        html += '<td><a href="' + (item.url || '#') + '" target="_blank">' + (item.url || '无链接') + '</a></td>';
                        html += '<td>' + (item.published_at || '未知') + '</td>';
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table></div>';
                    resultContent.innerHTML = html;
                } else {
                    resultContent.innerHTML = '<div class="alert alert-warning">测试成功，但未获取到内容</div>';
                }
                
                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('testResultModal'));
                modal.show();
            } else {
                showToast('错误', data.message || '测试失败', 'error');
            }
        })
        .catch(error => {
            console.error('测试采集源失败:', error);
            showToast('错误', '网络错误，请重试', 'error');
        });
}

// 从采集源创建任务
function createTaskFromSource(sourceId) {
    // 清空表单
    document.getElementById('taskName').value = '';
    document.getElementById('totalLimit').value = '50';
    
    // 选中对应的采集源
    const sourceCheckboxes = document.querySelectorAll('.source-checkbox');
    sourceCheckboxes.forEach(checkbox => {
        checkbox.checked = parseInt(checkbox.value) === sourceId;
    });
    
    // 清空分类选择
    const categoryCheckboxes = document.querySelectorAll('.category-checkbox');
    categoryCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('createTaskModal'));
    modal.show();
}

// 创建采集任务
function createTask() {
    const form = document.getElementById('createTaskForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // 获取选中的采集源
    const selectedSources = [];
    document.querySelectorAll('.source-checkbox:checked').forEach(checkbox => {
        selectedSources.push(parseInt(checkbox.value));
    });
    
    if (selectedSources.length === 0) {
        showToast('错误', '请至少选择一个采集源', 'error');
        return;
    }
    
    // 获取选中的分类
    const selectedCategories = [];
    document.querySelectorAll('.category-checkbox:checked').forEach(checkbox => {
        selectedCategories.push(checkbox.value);
    });
    
    const taskData = {
        task_name: document.getElementById('taskName').value,
        source_filters: selectedSources,
        category_filters: selectedCategories.length > 0 ? selectedCategories : null,
        total_limit: parseInt(document.getElementById('totalLimit').value)
    };
    
    fetch('/api/content-fetch/create-task', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('成功', '采集任务创建成功');
            // 关闭模态框并刷新页面
            const modal = bootstrap.Modal.getInstance(document.getElementById('createTaskModal'));
            modal.hide();
            setTimeout(() => window.location.reload(), 500);
        } else {
            showToast('错误', data.message || '创建失败', 'error');
        }
    })
    .catch(error => {
        console.error('创建采集任务失败:', error);
        showToast('错误', '网络错误，请重试', 'error');
    });
}

// 启动任务
function startTask(taskId) {
    fetch(`/api/content-fetch/start-task/${taskId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('成功', '任务已启动');
            // 更新UI
            const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
            if (row) {
                const statusCell = row.querySelector('td:nth-child(6) .status-badge');
                if (statusCell) {
                    statusCell.className = 'status-badge status-running';
                    statusCell.textContent = '运行中';
                }
                
                const actionCell = row.querySelector('td:nth-child(10) .btn-group');
                if (actionCell) {
                    actionCell.innerHTML = `
                        <button class="btn btn-outline-warning" onclick="stopTask(${taskId})" title="停止">
                            <i class="fas fa-stop"></i>
                        </button>
                        <button class="btn btn-outline-info" onclick="viewTaskDetails(${taskId})" title="详情">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteTask(${taskId})" title="删除">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                }
            }
        } else {
            showToast('错误', data.message || '启动失败', 'error');
        }
    })
    .catch(error => {
        console.error('启动任务失败:', error);
        showToast('错误', '网络错误，请重试', 'error');
    });
}

// 停止任务
function stopTask(taskId) {
    fetch(`/api/content-fetch/stop-task/${taskId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('成功', '任务已停止');
            // 更新UI
            const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
            if (row) {
                const statusCell = row.querySelector('td:nth-child(6) .status-badge');
                if (statusCell) {
                    statusCell.className = 'status-badge status-stopped';
                    statusCell.textContent = '已停止';
                }
                
                const actionCell = row.querySelector('td:nth-child(10) .btn-group');
                if (actionCell) {
                    actionCell.innerHTML = `
                        <button class="btn btn-outline-success" onclick="startTask(${taskId})" title="启动">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="btn btn-outline-info" onclick="viewTaskDetails(${taskId})" title="详情">
                            <i class="fas fa-info-circle"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteTask(${taskId})" title="删除">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                }
            }
        } else {
            showToast('错误', data.message || '停止失败', 'error');
        }
    })
    .catch(error => {
        console.error('停止任务失败:', error);
        showToast('错误', '网络错误，请重试', 'error');
    });
}

// 查看任务详情
function viewTaskDetails(taskId) {
    // 获取任务详情
    fetch(`/api/content-fetch/task/${taskId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayTaskDetails(data.task);
                // 显示模态框
                const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
                modal.show();
            } else {
                // 如果API不存在，回退到从页面数据获取
                const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
                if (!row) {
                    showToast('错误', '找不到任务信息', 'error');
                    return;
                }
                
                displayTaskDetailsFromRow(row);
            }
        })
        .catch(error => {
            console.error('获取任务详情失败:', error);
            // 如果API不存在，回退到从页面数据获取
            const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
            if (!row) {
                showToast('错误', '找不到任务信息', 'error');
                return;
            }
            
            displayTaskDetailsFromRow(row);
        });
}

// 从行数据显示任务详情
function displayTaskDetailsFromRow(row) {
    const taskName = row.querySelector('td:nth-child(2)').textContent;
    const sourceCount = row.querySelector('td:nth-child(3) .badge').textContent;
    const status = row.querySelector('td:nth-child(6) .status-badge').textContent;
    const progress = row.querySelector('.progress-bar').getAttribute('aria-valuenow');
    const resultCount = row.querySelector('td:nth-child(8)').textContent;
    const createdAt = row.querySelector('td:nth-child(9)').textContent;
    
    displayTaskDetailsContent(taskName, status, createdAt, sourceCount, resultCount, progress);
}

// 显示任务详情内容
function displayTaskDetails(task) {
    displayTaskDetailsContent(
        task.task_name,
        getStatusText(task.status),
        task.created_at.split('T')[0],
        `${task.source_ids.length} 个源`,
        task.result_count || 0,
        task.progress
    );
}

// 显示任务详情内容
function displayTaskDetailsContent(taskName, status, createdAt, sourceCount, resultCount, progress) {
    const detailContent = document.getElementById('taskDetailContent');
    
    let html = `
        <div class="mb-3">
            <h4>${taskName}</h4>
            <span class="badge bg-${getStatusColor(status)}">
                ${status}
            </span>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <p><strong>创建时间:</strong> ${createdAt}</p>
                <p><strong>采集源数量:</strong> ${sourceCount}</p>
            </div>
            <div class="col-md-6">
                <p><strong>已采集数量:</strong> ${resultCount} 条</p>
            </div>
        </div>
        
        <div class="mb-3">
            <h5>进度</h5>
            <div class="progress" style="height: 20px;">
                <div class="progress-bar" role="progressbar" 
                     style="width: ${progress}%; background: linear-gradient(90deg, #00d4ff 0%, #090979 100%);" 
                     aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
                    ${progress}%
                </div>
            </div>
        </div>
        
        <div class="alert alert-info">
            详细采集结果可在内容管理页面查看
        </div>
    `;
    
    detailContent.innerHTML = html;
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
    modal.show();
}

// 删除任务
function deleteTask(taskId) {
    if (!confirm('确定要删除此任务吗？此操作不可撤销。')) {
        return;
    }
    
    fetch(`/api/content-fetch/delete-task/${taskId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('成功', '任务已删除');
            // 移除任务行
            const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
            if (row) row.remove();
            
            // 如果没有任务了，显示空提示
            const taskRows = document.querySelectorAll('#tasks tbody tr');
            if (taskRows.length === 0) {
                document.querySelector('#tasks .table-responsive').innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                        <h4>暂无采集任务</h4>
                        <p class="text-muted">点击"创建采集任务"按钮创建新的内容采集任务</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                            <i class="fas fa-plus"></i> 创建采集任务
                        </button>
                    </div>
                `;
            }
        } else {
            showToast('错误', data.message || '删除失败', 'error');
        }
    })
    .catch(error => {
        console.error('删除任务失败:', error);
        showToast('错误', '网络错误，请重试', 'error');
    });
}

// 获取状态颜色
function getStatusColor(status) {
    const colors = {
        'pending': 'secondary',
        'running': 'primary',
        'completed': 'success',
        'failed': 'danger',
        'stopped': 'warning'
    };
    return colors[status] || 'secondary';
}

// 获取状态文本
function getStatusText(status) {
    const texts = {
        'pending': '等待中',
        'running': '运行中',
        'completed': '已完成',
        'failed': '失败',
        'stopped': '已停止'
    };
    return texts[status] || status;
}

// 显示提示消息
function showToast(title, message, type = 'success') {
    // 检查是否已存在Toast容器
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    // 创建Toast元素
    const toastId = 'toast-' + Date.now();
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type}`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    toast.setAttribute('id', toastId);
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <strong>${title}</strong>: ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // 显示Toast
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 3000
    });
    bsToast.show();
    
    // 自动移除
    toast.addEventListener('hidden.bs.toast', function () {
        toast.remove();
    });
}
</script>
{% endblock %}
