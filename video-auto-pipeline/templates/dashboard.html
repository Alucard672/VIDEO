{% extends "base.html" %}

{% block title %}仪表板 - 视频搬运矩阵自动化系统{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-tachometer-alt"></i>
        系统仪表板
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt"></i> 刷新
            </button>
        </div>
    </div>
</div>

<!-- 系统概览卡片 -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="metric-label">今日任务</div>
                        <div class="metric-value" id="today-tasks">{{ stats.today_tasks or 0 }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-tasks fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="metric-label">运行中任务</div>
                        <div class="metric-value" id="running-tasks">{{ stats.running_tasks or 0 }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-play-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="metric-label">今日视频</div>
                        <div class="metric-value" id="today-videos">{{ stats.today_videos or 0 }}</div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-video fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card metric-card">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="metric-label">系统状态</div>
                        <div class="metric-value">
                            <span class="status-badge status-running" id="system-status">正常</span>
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="fas fa-server fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 系统监控图表 -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line"></i>
                    系统性能监控
                </h5>
            </div>
            <div class="card-body">
                <canvas id="systemMetricsChart" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-microchip"></i>
                    实时系统状态
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>CPU使用率</span>
                        <span id="cpu-usage">0%</span>
                    </div>
                    <div class="progress progress-custom">
                        <div class="progress-bar" id="cpu-progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>内存使用率</span>
                        <span id="memory-usage">0%</span>
                    </div>
                    <div class="progress progress-custom">
                        <div class="progress-bar" id="memory-progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>磁盘使用率</span>
                        <span id="disk-usage">0%</span>
                    </div>
                    <div class="progress progress-custom">
                        <div class="progress-bar" id="disk-progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="text-center">
                    <small class="text-muted">最后更新: <span id="last-update">--</span></small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 最近任务和活动 -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clock"></i>
                    最近任务
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>任务名称</th>
                                <th>状态</th>
                                <th>进度</th>
                                <th>时间</th>
                            </tr>
                        </thead>
                        <tbody id="recent-tasks">
                            {% for task in recent_tasks %}
                            <tr data-task-id="{{ task.id }}">
                                <td>{{ task.name }}</td>
                                <td>
                                    <span class="status-badge status-{{ task.status }}">
                                        {{ task.status_text }}
                                    </span>
                                </td>
                                <td>
                                    <div class="progress progress-custom" style="height: 6px;">
                                        <div class="progress-bar task-progress" style="width: {{ task.progress }}%"></div>
                                    </div>
                                    <small>{{ task.progress }}%</small>
                                </td>
                                <td>
                                    <small>{{ task.created_time }}</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-center">
                    <a href="/tasks" class="btn btn-sm btn-outline-primary">查看所有任务</a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bell"></i>
                    系统通知
                </h5>
            </div>
            <div class="card-body">
                <div id="system-notifications">
                    {% for notification in notifications %}
                    <div class="alert alert-{{ notification.type }} alert-sm" role="alert">
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-{{ notification.icon }}"></i>
                            </div>
                            <div class="flex-grow-1 ms-2">
                                <strong>{{ notification.title }}</strong><br>
                                <small>{{ notification.message }}</small>
                                <div class="text-muted mt-1">
                                    <small>{{ notification.time }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="text-center">
                    <a href="/notifications" class="btn btn-sm btn-outline-primary">查看所有通知</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 快速操作 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt"></i>
                    快速操作
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-primary w-100" onclick="createTask('content_fetch')">
                            <i class="fas fa-download"></i><br>
                            <small>内容采集</small>
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-primary w-100" onclick="createTask('video_generation')">
                            <i class="fas fa-video"></i><br>
                            <small>生成视频</small>
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-primary w-100" onclick="showUploadDialog()">
                            <i class="fas fa-upload"></i><br>
                            <small>批量上传</small>
                        </button>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button class="btn btn-primary w-100" onclick="runMaintenance()">
                            <i class="fas fa-tools"></i><br>
                            <small>系统维护</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 任务创建模态框 -->
<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">创建新任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <div class="mb-3">
                        <label for="taskName" class="form-label">任务名称</label>
                        <input type="text" class="form-control" id="taskName" required>
                    </div>
                    <div class="mb-3">
                        <label for="taskType" class="form-label">任务类型</label>
                        <select class="form-select" id="taskType" required>
                            <option value="">请选择任务类型</option>
                            <option value="content_fetch">内容采集</option>
                            <option value="script_generation">脚本生成</option>
                            <option value="tts_generation">TTS生成</option>
                            <option value="video_editing">视频剪辑</option>
                            <option value="video_upload">视频上传</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="taskPriority" class="form-label">优先级</label>
                        <select class="form-select" id="taskPriority">
                            <option value="2">普通</option>
                            <option value="3">高</option>
                            <option value="4">紧急</option>
                            <option value="1">低</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="scheduledTime" class="form-label">计划执行时间</label>
                        <input type="datetime-local" class="form-control" id="scheduledTime">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitTask()">创建任务</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let systemMetricsChart;

// 初始化图表
function initSystemMetricsChart() {
    const ctx = document.getElementById('systemMetricsChart').getContext('2d');
    
    systemMetricsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'CPU使用率 (%)',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.4
                },
                {
                    label: '内存使用率 (%)',
                    data: [],
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.4
                },
                {
                    label: '磁盘使用率 (%)',
                    data: [],
                    borderColor: 'rgb(255, 205, 86)',
                    backgroundColor: 'rgba(255, 205, 86, 0.1)',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + '%';
                        }
                    }
                }
            }
        }
    });
}

// 更新系统指标
function updateSystemMetrics(metrics) {
    // 更新实时状态
    document.getElementById('cpu-usage').textContent = metrics.cpu_percent.toFixed(1) + '%';
    document.getElementById('cpu-progress').style.width = metrics.cpu_percent + '%';
    
    document.getElementById('memory-usage').textContent = metrics.memory_percent.toFixed(1) + '%';
    document.getElementById('memory-progress').style.width = metrics.memory_percent + '%';
    
    document.getElementById('disk-usage').textContent = metrics.disk_percent.toFixed(1) + '%';
    document.getElementById('disk-progress').style.width = metrics.disk_percent + '%';
    
    document.getElementById('last-update').textContent = formatTime(metrics.timestamp);
    
    // 更新图表
    const chart = systemMetricsChart;
    const now = new Date().toLocaleTimeString();
    
    chart.data.labels.push(now);
    chart.data.datasets[0].data.push(metrics.cpu_percent);
    chart.data.datasets[1].data.push(metrics.memory_percent);
    chart.data.datasets[2].data.push(metrics.disk_percent);
    
    // 保持最近20个数据点
    if (chart.data.labels.length > 20) {
        chart.data.labels.shift();
        chart.data.datasets.forEach(dataset => dataset.data.shift());
    }
    
    chart.update('none');
}

// 刷新仪表板
function refreshDashboard() {
    apiRequest('/api/dashboard/stats')
        .then(data => {
            document.getElementById('today-tasks').textContent = data.today_tasks || 0;
            document.getElementById('running-tasks').textContent = data.running_tasks || 0;
            document.getElementById('today-videos').textContent = data.today_videos || 0;
        });
    
    apiRequest('/api/dashboard/recent-tasks')
        .then(data => {
            updateRecentTasks(data.tasks);
        });
}

// 更新最近任务
function updateRecentTasks(tasks) {
    const tbody = document.getElementById('recent-tasks');
    tbody.innerHTML = '';
    
    tasks.forEach(task => {
        const row = document.createElement('tr');
        row.setAttribute('data-task-id', task.id);
        row.innerHTML = `
            <td>${task.name}</td>
            <td>
                <span class="status-badge status-${task.status} task-status">
                    ${getStatusText(task.status)}
                </span>
            </td>
            <td>
                <div class="progress progress-custom" style="height: 6px;">
                    <div class="progress-bar task-progress" style="width: ${task.progress}%"></div>
                </div>
                <small>${task.progress}%</small>
            </td>
            <td>
                <small>${formatTime(task.created_time)}</small>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// 创建任务
function createTask(taskType) {
    document.getElementById('taskType').value = taskType;
    
    // 根据任务类型设置默认名称
    const taskNames = {
        'content_fetch': '内容采集任务',
        'script_generation': '脚本生成任务',
        'tts_generation': 'TTS生成任务',
        'video_editing': '视频剪辑任务',
        'video_upload': '视频上传任务'
    };
    
    document.getElementById('taskName').value = taskNames[taskType] || '新任务';
    
    const modal = new bootstrap.Modal(document.getElementById('taskModal'));
    modal.show();
}

// 提交任务
function submitTask() {
    const form = document.getElementById('taskForm');
    const formData = new FormData(form);
    
    const taskData = {
        name: document.getElementById('taskName').value,
        task_type: document.getElementById('taskType').value,
        priority: parseInt(document.getElementById('taskPriority').value),
        scheduled_time: document.getElementById('scheduledTime').value || null
    };
    
    apiRequest('/api/tasks', {
        method: 'POST',
        body: taskData
    })
    .then(data => {
        showNotification('任务创建成功', 'success');
        bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
        refreshDashboard();
    })
    .catch(error => {
        showNotification('任务创建失败: ' + error.message, 'error');
    });
}

// 显示上传对话框
function showUploadDialog() {
    // 这里可以实现批量上传功能
    showNotification('批量上传功能开发中...', 'info');
}

// 运行系统维护
function runMaintenance() {
    confirmAction('确定要运行系统维护吗？这可能需要几分钟时间。', () => {
        apiRequest('/api/maintenance', {
            method: 'POST'
        })
        .then(data => {
            showNotification('系统维护任务已启动', 'success');
            refreshDashboard();
        })
        .catch(error => {
            showNotification('启动维护任务失败: ' + error.message, 'error');
        });
    });
}

// Socket.IO事件监听
socket.on('system_metrics', function(data) {
    updateSystemMetrics(data);
});

socket.on('dashboard_update', function(data) {
    if (data.type === 'task_stats') {
        document.getElementById('today-tasks').textContent = data.today_tasks || 0;
        document.getElementById('running-tasks').textContent = data.running_tasks || 0;
    } else if (data.type === 'recent_tasks') {
        updateRecentTasks(data.tasks);
    }
});

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    initSystemMetricsChart();
    
    // 定期刷新数据
    setInterval(refreshDashboard, 30000); // 每30秒刷新一次
    
    // 请求初始系统指标
    apiRequest('/api/monitoring/current-metrics')
        .then(data => {
            updateSystemMetrics(data);
        })
        .catch(error => {
            console.error('获取系统指标失败:', error);
        });
});
</script>
{% endblock %}